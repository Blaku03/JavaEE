<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:pt="http://xmlns.jcp.org/jsf/passthrough" template="/WEB-INF/template.xhtml">

    <f:metadata>
        <f:viewParam name="id" value="#{workoutSessionController.sessionId}" required="true" />
        <f:viewParam name="typeId" value="#{workoutSessionController.typeId}" />

        <f:viewAction action="#{workoutSessionController.loadSessionForEdit}" onPostback="false" />
    </f:metadata>

    <ui:define name="title">
        #{workoutSessionController.sessionId == 'new' ? msg['session.add'] : msg['session.edit']}
    </ui:define>

    <ui:define name="content">
        <h2>#{workoutSessionController.sessionId == 'new' ? msg['session.add'] : msg['session.edit']}</h2>

        <!-- Panel konfliktu wersji -->
        <h:panelGroup rendered="#{workoutSessionController.versionConflict}" styleClass="conflict-panel">
            <div class="conflict-warning">
                <h3>⚠️ #{msg['conflict.title']}</h3>
                <p>#{msg['conflict.message']}</p>

                <div class="conflict-comparison">
                    <!-- Wersja z bazy danych -->
                    <div class="conflict-column">
                        <h4>#{msg['conflict.databaseVersion']}</h4>
                        <table class="conflict-table">
                            <tr>
                                <th>#{msg['label.version']}</th>
                                <td>#{workoutSessionController.databaseVersion.version}</td>
                            </tr>
                            <tr>
                                <th>#{msg['label.status']}</th>
                                <td>#{workoutSessionController.databaseVersion.status}</td>
                            </tr>
                            <tr>
                                <th>#{msg['label.startTime']}</th>
                                <td>
                                    <h:outputText value="#{workoutSessionController.databaseVersion.startTime}">
                                        <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm" />
                                    </h:outputText>
                                </td>
                            </tr>
                            <tr>
                                <th>#{msg['label.endTime']}</th>
                                <td>
                                    <h:outputText value="#{workoutSessionController.databaseVersion.endTime}">
                                        <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm" />
                                    </h:outputText>
                                </td>
                            </tr>
                            <tr>
                                <th>#{msg['label.updatedAt']}</th>
                                <td>
                                    <h:outputText value="#{workoutSessionController.databaseVersion.updatedAt}">
                                        <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm:ss" />
                                    </h:outputText>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Dane użytkownika -->
                    <div class="conflict-column">
                        <h4>#{msg['conflict.yourVersion']}</h4>
                        <table class="conflict-table">
                            <tr>
                                <th>#{msg['label.version']}</th>
                                <td>#{workoutSessionController.userVersion.version}</td>
                            </tr>
                            <tr>
                                <th>#{msg['label.status']}</th>
                                <td>#{workoutSessionController.userVersion.status}</td>
                            </tr>
                            <tr>
                                <th>#{msg['label.startTime']}</th>
                                <td>
                                    <h:outputText value="#{workoutSessionController.userVersion.startTime}">
                                        <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm" />
                                    </h:outputText>
                                </td>
                            </tr>
                            <tr>
                                <th>#{msg['label.endTime']}</th>
                                <td>
                                    <h:outputText value="#{workoutSessionController.userVersion.endTime}">
                                        <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm" />
                                    </h:outputText>
                                </td>
                            </tr>
                            <tr>
                                <th>#{msg['label.updatedAt']}</th>
                                <td>
                                    <h:outputText value="#{workoutSessionController.userVersion.updatedAt}">
                                        <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm:ss" />
                                    </h:outputText>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <h:form styleClass="conflict-actions">
                    <h:commandButton value="#{msg['conflict.overwrite']}"
                        action="#{workoutSessionController.forceOverwrite()}" styleClass="btn btn-warning" />
                    <h:commandButton value="#{msg['conflict.refresh']}"
                        action="#{workoutSessionController.refreshFromDatabase()}" styleClass="btn" />
                </h:form>
            </div>
        </h:panelGroup>

        <h:form rendered="#{not workoutSessionController.versionConflict}">
            <h:messages globalOnly="false"
                style="color: red; list-style-type: none; padding: 0; margin-bottom: 1rem;" />

            <!-- Ukryte pole wersji dla optimistic locking -->
            <h:inputHidden value="#{workoutSessionController.session.version}" />

            <!-- Wyświetl wersję i timestampy dla istniejących sesji -->
            <h:panelGroup rendered="#{workoutSessionController.sessionId != 'new'}">
                <div class="form-info">
                    <span><strong>#{msg['label.version']}:</strong> #{workoutSessionController.session.version}</span>
                    <span style="margin-left: 20px;"><strong>#{msg['label.createdAt']}:</strong>
                        <h:outputText value="#{workoutSessionController.session.createdAt}">
                            <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm:ss" />
                        </h:outputText>
                    </span>
                    <span style="margin-left: 20px;"><strong>#{msg['label.updatedAt']}:</strong>
                        <h:outputText value="#{workoutSessionController.session.updatedAt}">
                            <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm:ss" />
                        </h:outputText>
                    </span>
                </div>
            </h:panelGroup>

            <div class="form-group">
                <h:outputLabel value="#{msg['session.category']}" for="category" />
                <h:selectOneMenu id="category" value="#{workoutSessionController.session.workoutType}"
                    converter="workoutTypeConverter" required="true"
                    requiredMessage="#{msg['session.categoryRequired']}">
                    <f:selectItem itemLabel="#{msg['session.selectCategory']}" itemValue="#{null}"
                        noSelectionOption="true" />
                    <f:selectItems value="#{workoutSessionController.allTypes}" var="type" itemLabel="#{type.name}"
                        itemValue="#{type}" />
                </h:selectOneMenu>
                <h:message for="category" styleClass="error-message" />
            </div>

            <div class="form-group">
                <h:outputLabel value="#{msg['label.status']}" for="status" />
                <h:selectOneMenu id="status" value="#{workoutSessionController.session.status}" required="true"
                    requiredMessage="#{msg['session.statusRequired']}">
                    <f:selectItems value="#{workoutSessionController.getWorkoutStatuses()}" var="status"
                        itemLabel="#{status}" itemValue="#{status}" />
                </h:selectOneMenu>
                <h:message for="status" styleClass="error-message" />
            </div>

            <div class="form-group">
                <h:outputLabel value="#{msg['label.startTime']}" for="startTime" />
                <h:inputText id="startTime" value="#{workoutSessionController.session.startTime}"
                    pt:type="datetime-local" required="true" requiredMessage="#{msg['session.startTimeRequired']}">
                    <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd'T'HH:mm" />
                </h:inputText>
                <h:message for="startTime" styleClass="error-message" />
            </div>

            <div class="form-group">
                <h:outputLabel value="#{msg['session.endTimeOptional']}" for="endTime" />
                <h:inputText id="endTime" value="#{workoutSessionController.session.endTime}" pt:type="datetime-local">
                    <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd'T'HH:mm" />
                </h:inputText>
                <h:message for="endTime" styleClass="error-message" />
            </div>

            <h:commandButton value="#{msg['btn.save']}" action="#{workoutSessionController.saveSession()}"
                styleClass="btn" />

            <h:link value="#{msg['btn.cancel']}" outcome="category_view.xhtml" styleClass="btn btn-danger"
                rendered="#{workoutSessionController.session.workoutType != null}">
                <f:param name="id" value="#{workoutSessionController.session.workoutType.id}" />
            </h:link>

            <h:link value="#{msg['btn.cancel']}" outcome="categories.xhtml" styleClass="btn btn-danger"
                rendered="#{workoutSessionController.session.workoutType == null}" />
        </h:form>
    </ui:define>

</ui:composition>